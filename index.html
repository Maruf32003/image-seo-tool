<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All-in-One AI Metadata & Renaming Tool</title>
    <link rel="icon" type="image/jpeg" href="https://i.ibb.co/qMj3MVMK/Md-Maruf-Hasan-Fiverr-Profile-Picture.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        /* Custom class for disabled button state */
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Custom transition for smoother UI updates */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        .filter-btn-active {
            background-color: #4f46e5;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Header -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
            <div class="flex items-center gap-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
                <h1 class="text-2xl md:text-3xl font-bold text-white">All-in-One Metadata Tool</h1>
            </div>
            <button id="settings-btn" class="p-2 rounded-md hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </header>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Panel: Controls & Instructions -->
            <aside class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col h-full">
                <!-- Top Section: Controls -->
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <button id="select-files-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>
                            Select Files
                        </button>
                        <button id="select-folder-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path></svg>
                            Select Folder
                        </button>
                    </div>
                    <button id="start-generation-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 btn-disabled">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></svg>
                        Start Generation
                    </button>
                    <div id="status-counters" class="p-4 bg-gray-900 rounded-lg text-center space-x-4 hidden">
                        <span id="total-count-wrapper">Total: <span id="total-count">0</span></span>
                        <span id="succeeded-count-wrapper" class="text-green-400 font-medium">Succeeded: <span id="succeeded-count">0</span></span>
                        <span id="failed-count-wrapper" class="text-red-400 font-medium">Failed: <span id="failed-count">0</span></span>
                    </div>
                    <div id="progress-container" class="hidden w-full space-y-2 pt-2">
                        <div class="flex justify-between items-center text-sm font-medium text-gray-400">
                            <span id="progress-text">Processing...</span>
                            <span id="progress-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-center gap-4 mt-2">
                            <button id="pause-btn" class="hidden w-1/2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-all">Pause</button>
                            <button id="resume-btn" class="hidden w-1/2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-all">Resume</button>
                        </div>
                    </div>
                    <div id="filter-controls" class="grid grid-cols-3 gap-2 hidden">
                        <button data-filter="all" class="filter-btn filter-btn-active py-2 px-4 rounded-md text-sm font-semibold bg-gray-700 hover:bg-gray-600">All</button>
                        <button data-filter="succeeded" class="filter-btn py-2 px-4 rounded-md text-sm font-semibold bg-gray-700 hover:bg-gray-600">Succeeded</button>
                        <button data-filter="failed" class="filter-btn py-2 px-4 rounded-md text-sm font-semibold bg-gray-700 hover:bg-gray-600">Failed</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="download-csv-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 btn-disabled">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                            Download CSV
                        </button>
                        <button id="download-zip-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 btn-disabled">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                            Download .zip
                        </button>
                    </div>
                     <div id="actions-controls" class="grid grid-cols-2 gap-4 hidden">
                        <button id="download-failed-zip-btn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 btn-disabled">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                            Download Failed
                        </button>
                        <button id="clear-succeeded-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 btn-disabled">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            Clear Succeeded
                        </button>
                    </div>
                </div>
                <!-- Bottom Section: Instructions -->
                <div class="flex-grow mt-8 pt-6 border-t border-gray-700 flex flex-col">
                    <h2 class="text-xl font-semibold mb-4 text-white">How it Works</h2>
                    <div class="space-y-4 text-gray-400">
                         <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">1</div>
                            <p>Click <strong class="text-gray-300">Settings</strong> (top right) to add your Google AI API key. You can get a free key from <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener noreferrer" class="text-blue-400 underline">Google AI Studio</a>.</p>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">2</div>
                            <p>Click <strong class="text-gray-300">Select Files</strong> or <strong class="text-gray-300">Folder</strong> to choose images.</p>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">3</div>
                            <p>Click <strong class="text-gray-300">Start Generation</strong> to create titles and keywords.</p>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">4</div>
                            <p>Use the <strong class="text-gray-300">filters</strong> and <strong class="text-gray-300">action buttons</strong> to manage and download your results.</p>
                        </div>
                    </div>
                    <div class="mt-auto pt-4 text-center text-xs text-gray-500">
                        Created by <a href="https://www.facebook.com/Maaruf32003" target="_blank" rel="noopener noreferrer" class="underline hover:text-blue-400">Maruf</a>
                    </div>
                </div>
                 <!-- Hidden file inputs -->
                <input type="file" id="file-input" class="hidden" multiple accept="image/png, image/jpeg, image/webp">
                <input type="file" id="folder-input" class="hidden" webkitdirectory directory multiple>
            </aside>

            <!-- Right Panel: Image Previews and Results -->
            <section id="results-panel" class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg min-h-[60vh]">
                <div id="bulk-actions-bar" class="hidden p-2 bg-gray-700 rounded-lg mb-4 flex items-center gap-4">
                    <input type="checkbox" id="select-all-checkbox" class="h-5 w-5 rounded bg-gray-900 border-gray-600 text-indigo-600 focus:ring-indigo-500">
                    <label for="select-all-checkbox" class="text-sm font-medium">Select All Visible</label>
                    <button id="retry-selected-btn" class="ml-auto bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded-lg text-sm btn-disabled">Retry Selected</button>
                    <button id="delete-selected-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm btn-disabled">Delete Selected</button>
                </div>
                <div id="results-container" class="space-y-6">
                    <div id="placeholder" class="text-center text-gray-500 py-20">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                        <h3 class="text-lg font-medium text-gray-400">Your images will appear here</h3>
                        <p class="text-sm">Select some images to get started.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden transition-all">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md transform transition-all scale-95 opacity-0" id="settings-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Settings</h2>
                <button id="close-settings-btn" class="p-2 rounded-full hover:bg-gray-700 text-gray-400">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-2">Google AI API Key</label>
                    <input type="password" id="api-key-input" class="w-full bg-gray-900 border border-gray-700 text-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Enter your API key">
                    <p class="text-xs text-gray-500 mt-2">Your key is stored only in your browser's local storage and is never shared.</p>
                </div>
                <button id="save-api-key-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all">Save Key</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden transition-all">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md transform transition-all scale-95 opacity-0" id="confirm-modal-content">
            <h2 id="confirm-title" class="text-2xl font-bold text-white mb-4">Are you sure?</h2>
            <p id="confirm-message" class="text-gray-400 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 text-white font-semibold">Cancel</button>
                <button id="confirm-action-btn" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Message/Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-xl translate-x-[120%] transition-transform duration-500">
        <p id="toast-message"></p>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM Element Selectors ---
    const settingsBtn = document.getElementById('settings-btn');
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const settingsModalContent = document.getElementById('settings-modal-content');
    const apiKeyInput = document.getElementById('api-key-input');
    const saveApiKeyBtn = document.getElementById('save-api-key-btn');
    const selectFilesBtn = document.getElementById('select-files-btn');
    const selectFolderBtn = document.getElementById('select-folder-btn');
    const fileInput = document.getElementById('file-input');
    const folderInput = document.getElementById('folder-input');
    const startGenerationBtn = document.getElementById('start-generation-btn');
    const downloadCsvBtn = document.getElementById('download-csv-btn');
    const downloadZipBtn = document.getElementById('download-zip-btn');
    const downloadFailedZipBtn = document.getElementById('download-failed-zip-btn');
    const clearSucceededBtn = document.getElementById('clear-succeeded-btn');
    const resultsContainer = document.getElementById('results-container');
    const placeholder = document.getElementById('placeholder');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressPercent = document.getElementById('progress-percent');
    const statusCounters = document.getElementById('status-counters');
    const totalCountEl = document.getElementById('total-count');
    const succeededCountEl = document.getElementById('succeeded-count');
    const failedCountEl = document.getElementById('failed-count');
    const totalCountWrapper = document.getElementById('total-count-wrapper');
    const succeededCountWrapper = document.getElementById('succeeded-count-wrapper');
    const failedCountWrapper = document.getElementById('failed-count-wrapper');
    const filterControls = document.getElementById('filter-controls');
    const actionsControls = document.getElementById('actions-controls');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmModalContent = document.getElementById('confirm-modal-content');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    const confirmActionBtn = document.getElementById('confirm-action-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const resumeBtn = document.getElementById('resume-btn');
    const bulkActionsBar = document.getElementById('bulk-actions-bar');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const retrySelectedBtn = document.getElementById('retry-selected-btn');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');

    // --- Application State & Constants ---
    const CONCURRENCY_LIMIT = 15; 
    let apiKey = '';
    let imageFiles = []; 
    let results = {}; 
    let currentFilter = 'all';
    let confirmActionCallback = null;
    let isPaused = false;
    let isProcessing = false;
    
    // Adobe Stock Categories
    const ADOBE_CATEGORIES = {
        1: "Animals", 2: "Buildings and Architecture", 3: "Business", 4: "Drinks", 5: "The Environment", 6: "States of Mind", 7: "Food", 8: "Graphic Resources", 9: "Hobbies and Leisure", 10: "Industry", 11: "Landscapes", 12: "Lifestyle", 13: "People", 14: "Plants and Flowers", 15: "Culture and Religion", 16: "Science", 17: "Social Issues", 18: "Sports", 19: "Technology", 20: "Transport", 21: "Travel"
    };
    const categoryListForPrompt = Object.entries(ADOBE_CATEGORIES).map(([id, name]) => `${id} - ${name}`).join('\n');

    // --- Initialization ---
    const init = () => {
        const savedKey = localStorage.getItem('googleAiApiKey');
        if (savedKey) {
            apiKey = savedKey;
            apiKeyInput.value = savedKey;
        }
        updateButtonStates();
        attachEventListeners();
    };

    // --- Event Listeners ---
    const attachEventListeners = () => {
        settingsBtn.addEventListener('click', openSettingsModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) closeSettingsModal();
        });
        saveApiKeyBtn.addEventListener('click', saveApiKey);
        
        selectFilesBtn.addEventListener('click', () => fileInput.click());
        selectFolderBtn.addEventListener('click', () => folderInput.click());

        fileInput.addEventListener('change', (e) => processFileObjects(e.target.files));
        folderInput.addEventListener('change', (e) => processFileObjects(e.target.files));

        startGenerationBtn.addEventListener('click', () => handleGeneration(getPendingImages()));
        downloadCsvBtn.addEventListener('click', handleCsvDownload);
        downloadZipBtn.addEventListener('click', handleZipDownload);
        downloadFailedZipBtn.addEventListener('click', handleFailedZipDownload);
        clearSucceededBtn.addEventListener('click', () => {
             openConfirmModal('Are you sure you want to clear all succeeded images?', () => {
                handleClearSucceeded();
                closeConfirmModal();
            });
        });

        filterControls.addEventListener('click', (e) => {
            if (e.target.matches('.filter-btn')) {
                currentFilter = e.target.dataset.filter;
                selectAllCheckbox.checked = false;
                renderResults();
            }
        });

        confirmCancelBtn.addEventListener('click', closeConfirmModal);
        confirmActionBtn.addEventListener('click', () => {
            if (typeof confirmActionCallback === 'function') {
                confirmActionCallback();
            }
        });

        pauseBtn.addEventListener('click', () => {
            isPaused = true;
            pauseBtn.classList.add('hidden');
            resumeBtn.classList.remove('hidden');
            progressText.textContent = 'Paused';
        });

        resumeBtn.addEventListener('click', () => {
            isPaused = false;
            resumeBtn.classList.add('hidden');
            pauseBtn.classList.remove('hidden');
            progressText.textContent = 'Resuming...';
        });

        selectAllCheckbox.addEventListener('change', handleSelectAll);
        retrySelectedBtn.addEventListener('click', handleRetrySelected);
        deleteSelectedBtn.addEventListener('click', handleDeleteSelected);
    };

    // --- UI Update Functions ---
    const updateButtonStates = () => {
        const hasApiKey = !!apiKey;
        const hasFiles = imageFiles.length > 0;
        const hasSucceeded = Object.values(results).some(r => r.status === 'Complete');
        const hasFailed = Object.values(results).some(r => r.status === 'Error');

        if (hasApiKey && hasFiles && !isProcessing) {
            startGenerationBtn.classList.remove('btn-disabled');
        } else {
            startGenerationBtn.classList.add('btn-disabled');
        }

        if (hasFiles && hasSucceeded && !isProcessing) {
            downloadCsvBtn.classList.remove('btn-disabled');
            downloadZipBtn.classList.remove('btn-disabled');
            clearSucceededBtn.classList.remove('btn-disabled');
        } else {
            downloadCsvBtn.classList.add('btn-disabled');
            downloadZipBtn.classList.add('btn-disabled');
            clearSucceededBtn.classList.add('btn-disabled');
        }

        if (hasFiles && hasFailed && !isProcessing) {
            downloadFailedZipBtn.classList.remove('btn-disabled');
        } else {
            downloadFailedZipBtn.classList.add('btn-disabled');
        }
    };

    const updateCounters = () => {
        const total = imageFiles.length;
        const succeeded = Object.values(results).filter(r => r.status === 'Complete').length;
        const failed = Object.values(results).filter(r => r.status === 'Error').length;

        totalCountEl.textContent = total;
        succeededCountEl.textContent = succeeded;
        failedCountEl.textContent = failed;
        
        totalCountWrapper.classList.toggle('hidden', currentFilter !== 'all');
        succeededCountWrapper.classList.toggle('hidden', currentFilter === 'failed');
        failedCountWrapper.classList.toggle('hidden', currentFilter === 'succeeded');
    };

    const renderResults = () => {
        updateCounters();
        let filteredImages = imageFiles;
        if (currentFilter === 'succeeded') {
            filteredImages = imageFiles.filter(img => results[img.id]?.status === 'Complete');
        } else if (currentFilter === 'failed') {
            filteredImages = imageFiles.filter(img => results[img.id]?.status === 'Error');
        }
        
        if (imageFiles.length > 0) {
            bulkActionsBar.classList.remove('hidden');
        } else {
            bulkActionsBar.classList.add('hidden');
        }
        
        if (filteredImages.length === 0 && imageFiles.length > 0) {
             resultsContainer.innerHTML = `<div class="text-center text-gray-500 py-20">
                <h3 class="text-lg font-medium text-gray-400">No images match the filter "${currentFilter}"</h3>
            </div>`;
            return;
        }
        
        if (imageFiles.length === 0) {
            placeholder.classList.remove('hidden');
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(placeholder);
            return;
        }

        placeholder.classList.add('hidden');
        resultsContainer.innerHTML = '';

        filteredImages.forEach(img => {
            const resultData = results[img.id] || { title: '', keywords: '', filename: '', category: '', status: 'Pending', errorMessage: '' };
            const card = document.createElement('div');
            card.id = `card-${img.id}`;
            card.className = 'bg-gray-900 p-4 rounded-lg shadow-md flex items-center gap-4 transition-all';
            
            let statusColor = 'text-yellow-400';
            if (resultData.status === 'Complete') statusColor = 'text-green-400';
            if (resultData.status === 'Error') statusColor = 'text-red-400';
            if (resultData.status === 'Generating...') statusColor = 'text-blue-400 animate-pulse';

            let actionAreaHtml = '';
            if (resultData.status === 'Error') {
                actionAreaHtml = `<div class="mt-2 flex items-center gap-4">
                                     <button onclick="retryIndividualImage('${img.id}')" class="text-sm bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded-lg transition-all">Try Again</button>
                                     ${resultData.errorMessage ? `<div class="text-xs text-red-400"><strong>Error:</strong> ${resultData.errorMessage}</div>` : ''}
                                  </div>`;
            }

            card.innerHTML = `
                <div class="flex-shrink-0">
                    <input type="checkbox" data-id="${img.id}" class="image-checkbox h-5 w-5 rounded bg-gray-900 border-gray-600 text-indigo-600 focus:ring-indigo-500" ${img.selected ? 'checked' : ''}>
                </div>
                <div class="flex-shrink-0 w-full md:w-48 h-32">
                    <img src="${img.objectUrl}" alt="${img.file.name}" class="w-full h-full object-cover rounded-md">
                </div>
                <div class="flex-grow space-y-2 w-full">
                    <div class="flex justify-between items-start">
                        <p class="font-semibold text-gray-300 break-all">${img.file.name}</p>
                        <span id="status-${img.id}" class="text-sm font-medium ${statusColor}">${resultData.status}</span>
                    </div>
                    <div>
                        <label for="title-${img.id}" class="text-xs font-medium text-gray-400">Title</label>
                        <textarea id="title-${img.id}" rows="2" class="w-full bg-gray-800 border border-gray-700 rounded-md p-2 text-sm focus:ring-1 focus:ring-blue-500" oninput="updateResult('${img.id}', 'title', this.value)">${resultData.title}</textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="filename-${img.id}" class="text-xs font-medium text-gray-400">New Filename (for .zip)</label>
                            <input type="text" id="filename-${img.id}" class="w-full bg-gray-800 border border-gray-700 rounded-md p-2 text-sm focus:ring-1 focus:ring-blue-500" value="${resultData.filename}" oninput="updateResult('${img.id}', 'filename', this.value)">
                        </div>
                        <div>
                            <label for="category-${img.id}" class="text-xs font-medium text-gray-400">Category</label>
                            <input type="text" id="category-${img.id}" class="w-full bg-gray-800 border border-gray-700 rounded-md p-2 text-sm focus:ring-1 focus:ring-blue-500" value="${resultData.category}" oninput="updateResult('${img.id}', 'category', this.value)">
                        </div>
                    </div>
                    <div>
                        <label for="keywords-${img.id}" class="text-xs font-medium text-gray-400">Keywords</label>
                        <textarea id="keywords-${img.id}" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded-md p-2 text-sm focus:ring-1 focus:ring-blue-500" oninput="updateResult('${img.id}', 'keywords', this.value)">${resultData.keywords}</textarea>
                    </div>
                    ${actionAreaHtml}
                </div>
            `;
            resultsContainer.appendChild(card);
        });
        
        // Add event listeners to new checkboxes
        document.querySelectorAll('.image-checkbox').forEach(cb => {
            cb.addEventListener('change', handleSelectionChange);
        });
        updateBulkActionState();
    };
    
    window.updateResult = (id, field, value) => {
        if (results[id]) {
            results[id][field] = value;
        }
    };

    window.retryIndividualImage = async (id) => {
        if (isProcessing) {
            showToast("Please wait for the current batch to finish before retrying.", "info");
            return;
        }
        const imageToRetry = imageFiles.find(img => img.id === id);
        if (imageToRetry) {
            await handleGeneration([imageToRetry]);
        }
    };

    const showToast = (message, type = 'success') => {
        toastMessage.textContent = message;
        toast.className = 'fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-xl transition-transform duration-500';
        if (type === 'success') toast.classList.add('bg-green-600');
        else if (type === 'error') toast.classList.add('bg-red-600');
        else toast.classList.add('bg-blue-600');
        
        toast.classList.remove('translate-x-[120%]');
        setTimeout(() => {
            toast.classList.add('translate-x-[120%]');
        }, 3000);
    };

    // --- Modal Logic ---
    const openSettingsModal = () => {
        settingsModal.classList.remove('hidden');
        setTimeout(() => settingsModalContent.classList.remove('scale-95', 'opacity-0'), 10);
    };

    const closeSettingsModal = () => {
        settingsModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => settingsModal.classList.add('hidden'), 300);
    };

    const openConfirmModal = (message, callback) => {
        document.getElementById('confirm-message').textContent = message;
        confirmActionCallback = callback;
        confirmModal.classList.remove('hidden');
        setTimeout(() => confirmModalContent.classList.remove('scale-95', 'opacity-0'), 10);
    };

    const closeConfirmModal = () => {
        confirmModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            confirmModal.classList.add('hidden');
            confirmActionCallback = null;
        }, 300);
    };

    const saveApiKey = () => {
        const key = apiKeyInput.value.trim();
        if (key) {
            apiKey = key;
            localStorage.setItem('googleAiApiKey', key);
            showToast('API Key saved successfully!');
            closeSettingsModal();
            updateButtonStates();
        } else {
            showToast('Please enter a valid API key.', 'error');
        }
    };

    // --- Core Functionality ---
    const processFileObjects = (fileList) => {
        imageFiles.forEach(img => URL.revokeObjectURL(img.objectUrl));

        const files = Array.from(fileList);
        const imageExtensions = ['.png', '.jpg', '.jpeg', '.webp'];
        
        const sanitizeForId = (str) => {
            return str.replace(/[^a-zA-Z0-9_-]/g, '-');
        };

        const imageFileObjects = files.filter(file => 
            imageExtensions.some(ext => file.name.toLowerCase().endsWith(ext))
        );

        if (imageFileObjects.length === 0) {
            showToast('No compatible image files found.', 'info');
            return;
        }
        
        imageFiles = imageFileObjects.map(file => {
            const id = `${sanitizeForId(file.name)}-${file.lastModified}-${file.size}`;
            const objectUrl = URL.createObjectURL(file);
            return { file, id, objectUrl, selected: false };
        });
        results = {};
        currentFilter = 'all';
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('filter-btn-active'));
        document.querySelector('.filter-btn[data-filter="all"]').classList.add('filter-btn-active');
        filterControls.classList.add('hidden');
        statusCounters.classList.add('hidden');
        actionsControls.classList.add('hidden');

        renderResults();
        updateButtonStates();
        showToast(`${imageFiles.length} image(s) ready.`);
        
        fileInput.value = '';
        folderInput.value = '';
    };
    
    const readFileAsBase64 = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    };

    const handleGeneration = async (imagesToProcess) => {
        if (isProcessing || imagesToProcess.length === 0) return;
        isProcessing = true;

        updateButtonStates();
        statusCounters.classList.remove('hidden');
        filterControls.classList.remove('hidden');
        actionsControls.classList.remove('hidden');
        pauseBtn.classList.remove('hidden');
        resumeBtn.classList.add('hidden');

        let completedCount = 0;
        
        progressContainer.classList.remove('hidden');
        updateProgress(completedCount, imagesToProcess.length);

        const queue = [...imagesToProcess];

        const processImage = async () => {
            while (queue.length > 0) {
                await new Promise(resolve => setTimeout(resolve, 100)); // Small delay to allow UI to update
                while (isPaused) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                const imageToProcess = queue.shift();
                if (imageToProcess) {
                    await generateMetadataForImage(imageToProcess);
                    completedCount++;
                    updateProgress(completedCount, imagesToProcess.length);
                    updateCounters();
                }
            }
        };

        const workers = Array.from({ length: CONCURRENCY_LIMIT }, processImage);
        await Promise.all(workers);

        isProcessing = false;
        isPaused = false;
        showToast('Processing complete!', 'success');
        updateButtonStates();
        renderResults(); // Final render to ensure UI is correct

        setTimeout(() => {
            progressContainer.classList.add('hidden');
            pauseBtn.classList.add('hidden');
            resumeBtn.classList.add('hidden');
        }, 2000);
    };
    
    const updateProgress = (completed, total) => {
        if (total === 0) return;
        const percent = Math.round((completed / total) * 100);
        progressBar.style.width = `${percent}%`;
        progressPercent.textContent = `${percent}%`;
        progressText.textContent = `Processing: ${completed} / ${total}`;
    };

    const generateMetadataForImage = async (img) => {
        try {
            updateStatus(img.id, 'Generating...');
            const base64Data = await readFileAsBase64(img.file);
            
            const prompt = `You are an expert stock photo metadata creator for Adobe Stock. Analyze this image and provide a title, keywords, and a category ID.
**Instructions:**
1.  **Title:** A single, concise sentence. Maximum 200 characters.
2.  **Keywords:** A comma-separated list of up to 49 relevant keywords.
3.  **Category ID:** Choose the single best category ID from the following list that the image belongs to.
    ${categoryListForPrompt}
**Output Format:** Respond with ONLY a valid JSON object with three keys: "title", "keywords", and "category". The "category" value must be a number from the list.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: img.file.type, data: base64Data } }] }],
                generation_config: { response_mime_type: "application/json" },
                safety_settings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                ]
            };

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();

            if (!response.ok || !result.candidates || result.candidates.length === 0) {
                 const errorMessage = result.error?.message || (result.promptFeedback ? `Blocked: ${result.promptFeedback.blockReason}` : 'Unknown API error');
                 throw new Error(errorMessage);
            }

            const contentText = result.candidates[0].content?.parts?.[0]?.text;
            if (!contentText) {
                 const blockReason = result.candidates[0].finishReason;
                 throw new Error(`Generation failed. Reason: ${blockReason}`);
            }
            
            const content = JSON.parse(contentText);
            const finalTitle = (content.title || '').substring(0, 200);
            const finalKeywords = (content.keywords || '').split(',').map(k => k.trim()).filter(Boolean).slice(0, 49).join(', ');
            const finalFilename = finalTitle.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-');
            const finalCategory = content.category || '';

            results[img.id] = { title: finalTitle, keywords: finalKeywords, filename: finalFilename, category: finalCategory, status: 'Complete' };
            updateStatus(img.id, 'Complete');
            
            document.getElementById(`title-${img.id}`).value = finalTitle;
            document.getElementById(`keywords-${img.id}`).value = finalKeywords;
            document.getElementById(`filename-${img.id}`).value = finalFilename;
            document.getElementById(`category-${img.id}`).value = finalCategory;

        } catch (error) {
            console.error(`Failed to process ${img.file.name}:`, error);
            results[img.id] = { title: '', keywords: '', filename: '', category: '', status: 'Error', errorMessage: error.message };
            updateStatus(img.id, 'Error', error.message);
        }
    };
    
    const updateStatus = (id, status, errorMessage = '') => {
        const card = document.getElementById(`card-${id}`);
        if (!card) return;
        
        const statusEl = card.querySelector(`#status-${id}`);
        if (!statusEl) return;
        
        if (!results[id]) results[id] = { title: '', keywords: '', filename: '', category: ''};
        results[id].status = status;
        results[id].errorMessage = errorMessage;
        
        statusEl.textContent = status;
        
        statusEl.className = 'text-sm font-medium';
        if (status === 'Complete') statusEl.classList.add('text-green-400');
        else if (status === 'Error') statusEl.classList.add('text-red-400');
        else if (status === 'Generating...') statusEl.classList.add('text-blue-400', 'animate-pulse');
        else statusEl.classList.add('text-yellow-400');

        const existingError = card.querySelector('.error-message-box');
        if (existingError) existingError.remove();

        if (status === 'Error' && errorMessage) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message-box mt-2 text-xs text-red-400 bg-red-900/50 p-2 rounded-md';
            errorDiv.innerHTML = `<strong>Error:</strong> ${errorMessage}`;
            const keywordsEl = card.querySelector(`#keywords-${id}`);
            if(keywordsEl && keywordsEl.parentElement) {
                keywordsEl.parentElement.appendChild(errorDiv);
            }
        }
    };

    const getSuccessfulImages = () => {
        return imageFiles.filter(img => results[img.id]?.status === 'Complete');
    };

    const getFailedImages = () => {
        return imageFiles.filter(img => results[img.id]?.status === 'Error');
    };
    
    const getPendingImages = () => {
        return imageFiles.filter(img => !results[img.id] || results[img.id]?.status === 'Pending');
    };

    const getSelectedImages = () => {
        return imageFiles.filter(img => img.selected);
    };

    const handleSelectionChange = () => {
        document.querySelectorAll('.image-checkbox').forEach(cb => {
            const img = imageFiles.find(i => i.id === cb.dataset.id);
            if (img) {
                img.selected = cb.checked;
            }
        });
        updateBulkActionState();
    };

    const handleSelectAll = (e) => {
        const isChecked = e.target.checked;
        const visibleImageIds = Array.from(document.querySelectorAll('.image-checkbox')).map(cb => cb.dataset.id);
        
        imageFiles.forEach(img => {
            if (visibleImageIds.includes(img.id)) {
                img.selected = isChecked;
            }
        });
        renderResults();
        updateBulkActionState();
    };

    const updateBulkActionState = () => {
        const selected = getSelectedImages();
        if (selected.length > 0) {
            deleteSelectedBtn.classList.remove('btn-disabled');
            if(selected.some(img => results[img.id]?.status === 'Error')) {
                retrySelectedBtn.classList.remove('btn-disabled');
            } else {
                retrySelectedBtn.classList.add('btn-disabled');
            }
        } else {
            deleteSelectedBtn.classList.add('btn-disabled');
            retrySelectedBtn.classList.add('btn-disabled');
        }
    };
    
    const handleRetrySelected = () => {
        const failedSelected = getSelectedImages().filter(img => results[img.id]?.status === 'Error');
        if (failedSelected.length > 0) {
            handleGeneration(failedSelected);
        } else {
            showToast('No failed images selected to retry.', 'info');
        }
    };
    
    const handleDeleteSelected = () => {
        const selectedIds = getSelectedImages().map(img => img.id);
        if (selectedIds.length === 0) {
            showToast('No images selected to delete.', 'info');
            return;
        }
        
        openConfirmModal(`Are you sure you want to delete ${selectedIds.length} selected image(s)?`, () => {
            imageFiles = imageFiles.filter(img => !img.selected);
            selectedIds.forEach(id => delete results[id]);
            renderResults();
            updateButtonStates();
            closeConfirmModal();
            showToast(`${selectedIds.length} image(s) deleted.`);
        });
    };

    const handleCsvDownload = () => {
        const successfulImages = getSuccessfulImages();
        if (successfulImages.length === 0) {
            showToast('No successful images to download.', 'error');
            return;
        }

        let csvContent = 'Filename,Title,Keywords,Category,Releases\n';
        successfulImages.forEach(img => {
            const result = results[img.id];
            const extension = img.file.name.split('.').pop();
            const filename = `${result.filename}.${extension}`;
            const title = `"${(result.title || '').replace(/"/g, '""')}"`;
            const keywords = `"${(result.keywords || '').replace(/"/g, '""')}"`;
            const category = result.category || '';
            const releases = ''; // Releases column is empty as per template

            csvContent += `${filename},${title},${keywords},${category},${releases}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'adobe_stock_metadata.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('CSV for successful images downloaded!');
    };

    const handleZipDownload = async () => {
        const successfulImages = getSuccessfulImages();
        if (successfulImages.length === 0) {
            showToast('No successful images to download.', 'error');
            return;
        }

        downloadZipBtn.classList.add('btn-disabled');
        startGenerationBtn.classList.add('btn-disabled');
        downloadCsvBtn.classList.add('btn-disabled');

        progressContainer.classList.remove('hidden');
        progressText.textContent = 'Zipping successful files...';
        updateProgress(0, successfulImages.length);

        try {
            const zip = new JSZip();
            let filesAdded = 0;

            for (const img of successfulImages) {
                const result = results[img.id];
                const extension = img.file.name.split('.').pop();
                const newFilename = `${result.filename}.${extension}`;
                
                zip.file(newFilename, img.file);
                filesAdded++;
                updateProgress(filesAdded, successfulImages.length);
            }

            progressText.textContent = 'Generating zip file...';
            const content = await zip.generateAsync({ type: "blob" });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = "ai_renamed_images.zip";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);

            showToast('Zip file of successful images downloaded!');

        } catch (error) {
            console.error("Error creating zip file:", error);
            showToast('Failed to create zip file.', 'error');
        } finally {
            updateButtonStates();
            setTimeout(() => {
                progressContainer.classList.add('hidden');
                updateProgress(0, 1);
            }, 2000);
        }
    };

    const handleFailedZipDownload = async () => {
        const failedImages = getFailedImages();
        if (failedImages.length === 0) {
            showToast('No failed images to download.', 'error');
            return;
        }
        
        progressContainer.classList.remove('hidden');
        progressText.textContent = 'Zipping failed files...';
        updateProgress(0, failedImages.length);

        try {
            const zip = new JSZip();
            let filesAdded = 0;

            for (const img of failedImages) {
                const extension = img.file.name.split('.').pop();
                const newFilename = `failed-${filesAdded + 1}.${extension}`;
                
                zip.file(newFilename, img.file);
                filesAdded++;
                updateProgress(filesAdded, failedImages.length);
            }

            progressText.textContent = 'Generating zip file...';
            const content = await zip.generateAsync({ type: "blob" });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = "failed_images.zip";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);

            showToast('Zip file of failed images downloaded!');

        } catch (error) {
            console.error("Error creating zip file:", error);
            showToast('Failed to create zip file.', 'error');
        } finally {
            setTimeout(() => {
                progressContainer.classList.add('hidden');
                updateProgress(0, 1);
            }, 2000);
        }
    };

    const handleClearSucceeded = () => {
        const successfulIds = getSuccessfulImages().map(img => img.id);
        
        imageFiles = imageFiles.filter(img => !successfulIds.includes(img.id));
        
        successfulIds.forEach(id => {
            delete results[id];
        });

        showToast('Cleared all successful images.');
        currentFilter = 'all';
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('filter-btn-active'));
        document.querySelector('.filter-btn[data-filter="all"]').classList.add('filter-btn-active');
        
        renderResults();
        updateButtonStates();
        
        if(imageFiles.length === 0) {
            statusCounters.classList.add('hidden');
            filterControls.classList.add('hidden');
            actionsControls.classList.add('hidden');
        }
    };

    init();
});
</script>

</body>
</html>
